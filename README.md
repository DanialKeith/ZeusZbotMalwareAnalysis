# Zeus (Zbot) Banking Trojan - Malware Analysis

## DISCLAIMER ⚠️
This content is presented strictly as a proof of concept for educational and analytical purposes in the context of malware analysis. Users must exercise extreme caution and adhere to all legal guidelines when interacting with this material. I am not responsible for any harm, including but not limited to computer viruses or cybersecurity breaches, that may result from improper handling or misuse of this information.

## Introduction
This report documents the process of setting up and analyzing malware in a cloud-based laboratory on AWS, using Terraform for lab setup and FlareVM for malware analysis.
## Lab Creation and Analysis Process
### 1. Setting Up the [AWS Cloud Malware Machine](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine)
-	**Terraform AWS Cloud Malware-Lab Initialization:**
    -	Initiated a new Terraform AWS Cloud Malware-lab for malware analysis.
### 2. Downloading and Securing the Trojan
-	**Trojan Acquisition:**
    - Reestablished internet connectivity for analysis: ``Get-NetAdapter -Name "Ethernet 2" | Set-DnsClientServerAddress -ResetServerAddresses``.	
    -	Downloaded the ``Zeus Banking Trojan (Version 26-Nov-2013)`` from [theZoo GitHub](https://github.com/ytisf/theZoo).
-	**Securing Network with INETSIM:**
    -	Safely extracted the trojan and positioned it on the desktop for analysis.
      
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/c57ec9d8-57bb-4f42-9d72-16a2967fcdd0)


### 3. Analyzing the Malware
-	**VirusTotal Examination:**

    -	Utilized [VirusTotal](https://www.virustotal.com/gui/home/upload), which identified 63 security vendors and 4 sandboxes marking the file as malicious.

![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/fa880106-1421-4e22-a50b-d1c6fc5f7205)
![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/f5d55efb-5d36-4f66-a5e3-c5966e11c86f)

-	**Malware Composition and Hashes:**
    -	Malware File Name: ``invoice_2318362983713_823931342io[.]pdf[.]exe``
    -	MD5: ``ea039a854d20d7734c5add48f1a51c34``
    -	SHA1: ``9615dca4c0e46b8a39de5428af7db060399230b2``
    -	SHA256: ``69e966e730557fde8fd84317cdef1ece00a8bb3470c0b58f3231e170168af169``
    -	File Header:
      ```
        4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00 B8 00 00 00 00 00 00 00 40
        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
        00 00 00 00 00 00 00 00 00 00 D8 00 00 00 0E 1F BA 0E 00 B4 09 CD 21 B8 01
        4C CD 21 54 68 69 73 20 70 72 6F 67 72 61 6D 20 63 61 6E 6E 6F 74 20 62 65
        20 72 75 6E 20 69 6E 20 44 4F 53 20 6D 6F 64 65 2E 0D 0D 0A 24
-	Implemented INETSIM for network safety using PowerShell in FlareVM: ``Get-NetAdapter -Name "Ethernet 2" | Set-DnsClientServerAddress -ServerAddresses "172.16.10.6"``.
### 4. Static Analysis Investigation
-	**Using Pestudio for In-Depth Analysis:**
    -	Conducted further investigation with Pestudio, revealing suspicious API calls and string values, suggesting VM/Sandbox evasion techniques. I have put them into two lists below:

<br/>
<br/>
 
<details>
  <summary><strong>Suspected Function Calls</strong></summary>
  
- AsksmaceaglyBubuPulsKaifTeasMistPeelGhisPrimChaoLyreroeno
- KERNEL32[.]MulDiv
- BagsSpicDollBikeAzonPoopHamsPyasmap
- KERNEL32[.]SetCurrentDirectoryA
- BardHolyawe
- SHLWAPI[.]SHFreeShared
- BathEftsDawnvilepughThroCymakohloverMitefuzerat
- SHLWAPI[.]PathMakeSystemFolderW
- BemaCadsPodsWavyCedeRadsbrioOustPerefenom
- USER32[.]SetDlgItemTextW
- BullbonyaweeWaitsnugTierDriblibye
- KERNEL32[.]VirtualQuery
- CameValeWauler
- USER32[.]IsIconic
- CedeSalsshulLimyThroliraValeDonabox
- USER32[.]CreateCaret
- CellrotoCrudUntohighCols
- KERNEL32[.]CreateFileA
- DenyLubeDunssawsOresvarut
- SHLWAPI[.]PathRemoveFileSpecA
- DragRoutflusCrowPeatmownNewsyaksSerfmare
- USER32[.]DestroyIcon
- Dumpcotsavo
- USER32[.]SetDlgItemInt
- DungBadebankBangGelthoboCocaBozotsksWheyVaryShoghoseNipsCadisi
- USER32[.]EndPaint
- ExitRollWoodGumsgamaSloerevsWussletssinkYearZitiryesHypout
- USER32[.]GetClassInfoW
- FociTalcileador
- KERNEL32[.]ConvertDefaultLocale
- GeneAilshe
- KERNEL32[.]FindFirstFileA
- GhisGoodHowlCoonCigscateged
- KERNEL32[.]GetWindowsDirectoryA
- GimpWadsdashHoraYardSeatDeanScanscowRantKeasfib
- KERNEL32[.]LCMapStringW
- Haesourfe
- USER32[.]GetKeyNameTextA
- HoggSoonLasstwaeNapeCeilBawlscopdub
- KERNEL32[.]SystemTimeToFileTime
- Icontellnoway
- SHLWAPI[.]PathRemoveBlanksW
- ImidslatJokyCombdrubChefBilkSale
- USER32[.]GetShellWindow
- IzararfsFlamWostAirsconsMouefemelallPoretweeSacsOxidMinx
- SHLWAPI[.]PathAddExtensionA
- JabsNaveFateLariManyLeeksecshiesBawlwoo
- KERNEL32[.]CreateIoCompletionPort
- KatsDoreOmerBetsKoraKeef
- KERNEL32[.]GetShortPathNameA
- KineChamLows
- KERNEL32[.]SetCurrentDirectoryW
- LeerMiff
- KERNEL32[.]LeaveCriticalSection
- MaarSectFiscNextMattbamsErasnimstoeaBadshon
- USER32[.]GetClassInfoW
- MarkMokeOsesShwaSkegpornlimemim
- KERNEL32[.]GetStartupInfoW
- MeanOrrabirogirtWorkGawpSassPirnVinoLotaPledEidefe
- SHLWAPI[.]SHLockShared
- NextLoveOralwanySurfhm
- KERNEL32[.]VerSetConditionMask
- NisiBoyolineJiaoveryObiaowedblamHaetMaulweensky
- SHLWAPI[.]PathCanonicalizeW
- OastcabskamiKartDumbInksSomsMass
- KERNEL32[.]SetCurrentDirectoryA
- PeckQuinFillrillsaw
- KERNEL32[.]GetThreadPriority
- RamilimaputtHastJobs
- KERNEL32[.]FindNextFileW
- RemsSlaySoreAnoaaxalbuffusesemeuMapsyogaHangLoud
- SHLWAPI[.]PathMakePrettyA
- RidsFineZingMickMomsdue
- USER32[.]GetMonitorInfoW
- SeminerdsoloseenYaginobox
- SHLWAPI[.]PathIsLFNFileSpecA
- SiretomsbritGrewIckyNapaLumsBoaren
- KERNEL32[.]OpenFileMappingA
- SlabKitsSlayseptPfftjiffSabsdeskOafsNowtMemsKirnKepiMiffDunt
- KERNEL32[.]OpenSemaphoreW
- SoldKartAgueiliaRushWauldhal
- SHLWAPI[.]PathIsUNCW
- SuitplieGunsMaidBaitFeusJiaotodycolyAlbsLuneToyspe
- USER32[.]GetPropW
- SungActaKopsMaarposyparefuzedeck
- SHLWAPI[.]PathIsDirectoryA
- ToeaTailecusGeesSoliCadeSpueEndsPlaykaphall
- SHLWAPI[.]PathRemoveArgsW
- Vavsrubepodsjadebrooli
- USER32[.]GetUpdateRgn
- VeerCrawFlateel
- SHLWAPI[.]PathParseIconLocationA
- WainMeekPinyWonkpooflaudsir
- KERNEL32[.]GetWindowsDirectoryW
- WhopTestrangrapsdebsTzarNipaYins
- KERNEL32[.]DeleteFileA
- YeukMags
- KERNEL32[.]GlobalHandle
- ZetaBeduPirnhipsjailTingSrisTeleAposhuskNameHoerflagemuwo
- USER32[.]LoadIconA

</details>


<br/>
<details>
  <summary><strong>API Calls</strong></summary>

- AllowSetForegroundWindow
- GetCapture
- GetWindowTextLength
- GetEnvironmentVariable
- VkKeyScan
- GetAsyncKeyState
- PathRenameExtension
- WriteFile
- FindNextFile
- GetCurrentThread
- WinExec
- GlobalAddAtom
- GetClipboardOwner
- GetClipboardData
- EnumClipboardFormats
- DdeQueryNextServer
- GetConsoleAliasExesLength
- SetCurrentDirectory
   </details>

<br/>

  - Found an export of ``Corect[.]com`` which yielded nothing interesting within the [Wayback Machine](http://web.archive.org/web/20130801000000*/corect.com).

  ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/1a4497bd-ad08-42f2-b164-92e75bda535e)
  
  - Noted the similarity in raw size and virtual size, indicating the malware is likely not compressed.

  ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/9c02ced0-643d-4bb7-afb1-26c646dc5d1e)


-	**Using a Basic Capa Output:**
    -	It appeared this Zeus variant uses VM / Sandbox Evasion techniques to avoid inspection.
    -	Based on ATT&CK Tactic it is Defense Evasion and the technique is Virtualization/Sandbox Evasion T1497.001
 
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/349d8b80-9963-46c4-8a7c-f4365b5ff21e)
 	

-	**Using Cutter:**
    -	Utilized Cutter to graph the ``GetTickCount()`` function, a critical component in understanding the malware's behavior.

    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/9168d358-cfe5-497c-b2ef-71dbadef3b21)


    -	This analysis primarily focused on determining the runtime duration of the Windows machine, aligning with MITRE ATT&CK sub-technique 3 T1497.003.
    -	Investigated a sequence of unusual strings linked to DLL functions, such as ``CellrotoCrudUntohighCols`` and ``KERNEL32[.]CreateFileA``. These strings likely represent unique function names used internally by the malware.
      
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/4551ab0e-eb3b-434f-942f-e39837fe5cb6)
 	
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/79bfa0a6-f8a6-4572-ba60-70cc00a30d85)

    -	Noted that the string ``icgH`` is located 19 address spaces away from the ``KERNEL32[.]MulDiv`` function, indicating proximity and potential relevance in the malware's execution process.
      
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/3d86b602-a26c-4c22-9901-96ef14f0b49c)
 	
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/357b7346-47dc-4271-b30e-8d495886c7d7)

-	**Dynamic Analysis with Host-based Indicators:**
    -	Utilized tools like Procmon, INetSim, and Wireshark for dynamic analysis.
    -	In Procmon, the 'invoice' parent process was observed to have two child processes, including a suspended ``cmd[.]exe`` linked to ``conhost[.]exe``.
      
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/39e3413f-24e5-4502-ade6-ec5e3d020eda)

    -	The malware embeds ``GoogleUpdate[.]exe`` within a process chain starting from ``wininit[.]exe`` to ``svchost[.]exe``.
 
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/71786c13-4f88-4fbf-b785-ce6bd913121e)

    -	Using Procmon's filter on 'invoice', identified 1619 instances, suggesting the creation of a new registry value within the Google Update location. This implies the malware could be triggered with each Chrome update.
 
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/53fab355-984b-4adb-9cf5-9f94f001609b)


    -	Captured a suspicious HTTP request to ``fpdownload[.]macromedia[.]com`` in Wireshark. An nslookup of this domain returned an IP address ``23[.]192[.]235[.]212`` not marked as malicious on VirusTotal.
    -	Found that searching for ``fpdownload[.]macromedia[.]com`` led to an ``Any[.]Run`` analysis page displaying behavior akin to that observed during the malware's execution.
 
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/60caf6d9-efe4-44cd-b171-dbde7c40b892)
 	
    ![image](https://github.com/DanialKeith/ZeusZbotMalwareAnalysis/assets/154257195/5ad2b8a4-f07b-4cf9-ac9e-78256b5d8b4f)


## Conclusion
These analytical steps offer deeper insight into the malware's functionality, ranging from system runtime checks to registry manipulations and network communication patterns. This comprehensive analysis aids in understanding the sophisticated mechanisms employed by the malware for evasion and execution.
